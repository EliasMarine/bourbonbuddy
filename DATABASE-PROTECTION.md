# Database Protection System

This document outlines the database protection measures implemented to prevent data loss in the Bourbon Buddy application.

## Overview

The database protection system includes:

1. **Automatic Backups**: Backups are created automatically before app startup
2. **Database Verification**: Database integrity is checked on startup
3. **Auto-Recovery**: The system attempts to recover automatically if issues are detected
4. **Safe Migrations**: A protected way to run database migrations with automatic backup/restore
5. **Manual Backup and Restore Tools**: Utilities for managing database backups
6. **Scheduled Backup System**: Support for daily, weekly, and monthly backups

## Automatic Protection Features

These features run automatically:

- **Pre-startup Check**: Every time you run `npm run dev` or `npm run start`, the system:
  - Verifies database integrity
  - Creates a backup (keeping the 10 most recent)
  - Automatically restores from backup if issues are detected
  - Seeds the database if it's empty

## Available Commands

### Daily Use

- `npm run dev` - Runs the dev server with database protection
- `npm run start` - Runs the production server with database protection

### Database Management

- `npm run db:backup` - Creates a manual backup of the database
- `npm run db:restore` - Interactive tool to restore from a backup
- `npm run db:verify` - Verifies database integrity
- `npm run db:check` - Shows database statistics
- `npm run db:migrate` - Safely run Prisma migrations with backup/restore protection

## Automated Backup System

The application includes a script for scheduled backups that can be set up with cron:

### Backup Schedule
- **Daily backups**: Created every day, kept for 7 days
- **Weekly backups**: Created every Sunday, kept for 4 weeks
- **Monthly backups**: Created on the 1st of each month, kept for 6 months

### Setting Up Cron Backups

To set up automated backups with cron:

1. Edit your crontab:
   ```
   crontab -e
   ```

2. Add a line to run the backup script (example: daily at 2 AM):
   ```
   0 2 * * * cd /path/to/your/app && /usr/local/bin/ts-node scripts/cron-backup.ts >> logs/db-backup.log 2>&1
   ```

3. Make sure the logs directory exists:
   ```
   mkdir -p logs
   ```

## In Case of Data Loss

If you experience data loss:

1. Stop the application
2. Run `npm run db:verify` to check database status
3. Run `npm run db:restore` to restore from a backup
4. If no backups are available, run `npm run seed` to populate with test data

## Directory Structure

- `database-backups/` - Contains all database backups
  - Regular backups are named `backup-[timestamp].db`
  - Pre-migration backups are named `pre-migration-[timestamp].db`
  - Pre-restore backups are named `pre-restore-[timestamp].db`
  - `/daily` - Daily backups generated by cron
  - `/weekly` - Weekly backups generated by cron
  - `/monthly` - Monthly backups generated by cron

## Best Practices

1. **Always use the safe migration tool**: Run `npm run db:migrate` instead of direct Prisma commands
2. **Create manual backups before major changes**: Run `npm run db:backup` before significant changes
3. **Run verification regularly**: Check the database with `npm run db:verify`
4. **Don't delete backups manually**: Let the system manage the backup rotation
5. **Keep database backups in a separate location**: Periodically copy the `database-backups` folder to external storage
6. **Set up cron backups**: Configure the cron job to run daily backups
7. **Monitor backup logs**: Check for errors in the backup logs periodically

## Troubleshooting

If the application fails to start:

1. Check for errors in the console output
2. Run `npm run db:verify` to check database status
3. If database issues are detected, run `npm run db:restore` to restore from a backup
4. If no backups are available, run `npm run seed` to populate with test data 